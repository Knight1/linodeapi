#!/bin/bash

set -e
set -u

# Bash Colors
red=`tput setaf 1`
green=`tput setaf 2`
yellow=`tput setaf 3`
white=`tput setaf 7`
bold=`tput bold`
reset=`tput sgr0`

#######################################
# Echo/log function
# Arguments:
#   String: value to log
#######################################
log() {
  if [[ "$@" ]]; then echo -e "${bold}${green}[LINODE API `date +'%T'`]${reset} $@";
  else echo; fi
}

#######################################
# Log error. Similar to log(), but red.
# Arguments:
#   String: value to print out as error
#######################################
error() {
  echo -e "${bold}${red}[LINODE API `date +'%T'`]${reset} ${red}$@${reset}";
}

#########################################################
# Verify that command is installed
# Arguments:
#   String: command name
#########################################################
function assert_command_installed() {
  if [ ! $(command -v $1) ]; then
    error "Command *$1* not installed. Please install it." "\n"
    exit 1
  fi
}

#########################################################
# Resolve this script (./linode) real path, even
# if it is a symlink. We need it to correctly point
# the ./$LINODEAPI file, which is expected to be
# next to this file.
#
# Source: http://stackoverflow.com/questions/59895/can-a-bash-script-tell-what-directory-its-stored-in
#########################################################
function resolve_current_script_dir() {
  local source="${BASH_SOURCE[0]}"
  local dir=""
  while [ -h "$source" ]; do
    dir="$( cd -P "$( dirname "$source" )" && pwd )"
    source="$(readlink "$source")"
    [[ $source != /* ]] && source="$dir/$source"
  done
  echo "$( cd -P "$( dirname "$source" )" && pwd )"
}

#########################################################
# Lists plans available on Linode
#########################################################
function list_plans() {
  local allplans=$($LINODEAPI -c avail.linodeplans -d api_responseFormat=json)
  local planid=$(echo $allplans | jq '.DATA[].PLANID' | sed 's/^/Planid: /')
  local cores=$(echo $allplans | jq '.DATA[].CORES' | sed 's/^/ Cores: /')
  local ram=$(echo $allplans | jq '.DATA[].RAM' | sed 's/^/ RAM: /' | sed 's/$/ MB/')
  local price=$(echo $allplans | jq '.DATA[].HOURLY' | sed 's/^/ Price: \$/' | sed 's/$/ p\/h/')
  paste <(echo "$planid") <(echo "$cores") <(echo "$ram") <(echo "$price")
}

#########################################################
# Lists data centers available on Linode
#########################################################
function list_datacenters() {
  echo "$($LINODEAPI -c avail.datacenters | grep 'DATACENTERID\|ABBR' | sed 's/^.*://g' | sed 's/"/ /g' | xargs -n2 echo | sed 's/^/Datacenter ID: /')"
}


# Internal variables
SCRIPT_DIR=$(resolve_current_script_dir) # script dir (if symlink, it will be resolved to the target)
LINODEAPI="$SCRIPT_DIR/linodeapi"

# ENV variables provided by user
LINODE_KEY=${LINODE_KEY:=""}

# Internal variables
NODE_NAME=""
NODE_PLAN=""
DATACENTER=""
TOKEN=""
CLOUD_CONFIG_CONTENT=""
DATA_SIZE="no-data"




# Make sure we have all required command installed
for required_cmd in curl pwgen sshpass sudo jq; do
  assert_command_installed $required_cmd
done

# Check if GitHub and Linod API Keys are installed on your system
if [[ -z $LINODE_KEY ]]; then
  error "Linode API key environmental variable not set!" "\n" \
    "Please add into your .bashrc file " "\n" "\"export LINODE_KEY=your-Key\"" "\n" \
    "See Linode manual for more info: https://www.linode.com/api"
  exit 1
fi

# Options
# translate long options to short
for i in "$@"
do
  case $i in
    -n=*|--node-name=*)
      NODE_NAME="${i#*=}"
      ;;
    -p=*|--node-plan=*)
      NODE_PLAN="${i#*=}"
      ;;
    -s=*|--data-size=*)
      DATA_SIZE="${i#*=}"
      ;;
    -d=*|--datacenter=*)
      DATACENTER="${i#*=}"
      ;;
    -t=*|--token=*)
      TOKEN="${i#*=}"
      ;;
    -c=*|--cloud-config=*)
      CLOUD_CONFIG_CONTENT="${i#*=}"
      ;;
    -z*|--list-plans*)
      log "Available Linode plans:"
      list_plans
      exit 0
      ;;
    -x*|--list-datacenters*)
      log "Available Linode data centers:"
      list_datacenters
      exit 0
      ;;
    -h|--help)
      echo -e "
      Linode Bash API CoreOS Deployment Help
      opnions:

      -h|--help (-h)            help
      -n|--node-name (-n)       Node name (required)
      -s|--data-size (-s)       Size of data partition (optional)
      -p|--node-plan (-p)       Node plan (required)
      -d|--datacenter (-d)      Datacenter of your choice (required)
      -t|--token (-t)           ETCD Token

      CoreOS cloud_config:
      --cloud-config (-c)       cloud-config yaml content. Provide using --cloud-config=\"\$(< path/to/your/cloud-config.yaml)\"

      ${yellow}Get Details From Linode API: $reset
      --list-plans (-z)         List linode plans
      --list-datacenters (-x)   List linode datacenters

      For more informations on Linode/Github API keys please go to project page:
      ${white}https://github.com/million12/linodeapi$reset" "\n"

      exit 1
      ;;
    *)
      error "Unknown option ${bold}$i${reset}."
      log   "Type ${bold}--help${reset} or ${bold}-h${reset} for all available options."
      exit 1;
      ;;
  esac
done


# Check if node name provided by user
if [[ -z $NODE_NAME ]]; then
  error "Node name not provided." "\n" "Please provide node name using --node-name=YOUR_NODE_NAME" "\n"
  exit 1
fi
# Check if node plan provided by user
if [[ -z $NODE_PLAN ]]; then
  error "Node plan not provided." "\n" "Please provide node name using --node-plan=X" "\n"
  $0 --list-plans
  exit 1
fi
# Check if datacenter id provided by user
if [[ -z $DATACENTER ]]; then
  error "Datacenter ID not provided." "\n" "Please provide it using --datacenter=X" "\n"
  $0 --list-datacenters
  exit 1
fi
# Check if cloud config has been provided
if [[ -z $CLOUD_CONFIG_CONTENT ]]; then
  error "Empty --cloud-config content, it won't work!" "\n" \
    "You must provide your cloud config." "\n" \
    "Hint: --cloud-config=\"\$(< path/to/your/cloud-config.yaml)\""
  exit 1
fi


log "Creating node ${bold}${white}$NODE_NAME${reset}" \
 "in data center ${bold}${white}$DATACENTER${reset}," \
 "plan ${bold}${white}$NODE_PLAN${reset}."


# Set Random Password for BootOS Partition.
PASSWD=$(pwgen -c -n -1 16)

# Create WorkDir for the process
mkdir -p $HOME/linode/$NODE_NAME
workdir="$HOME/linode/$NODE_NAME"
echo "$PASSWD" > $workdir/password
# Check if token provided by user. if not generate new one.
if [ -z $TOKEN ]; then
  log "No ETCD token provided. Generating new one..."
  TOKEN=$(curl -s https://discovery.etcd.io/new | sed "s#https://discovery.etcd.io/##")
  log "Generated token: ${bold}${white}$TOKEN${reset}."
fi

# Create node with provided name
$LINODEAPI -c linode.create -d DATACENTERID=$DATACENTER\&PLANID=$NODE_PLAN | grep LinodeID | sed 's/^.*://' > $workdir/nodeid.txt

# Get Linode ID
linodeid=`cat $workdir/nodeid.txt`

# Rename ndoe to user specific
$LINODEAPI -c linode.update -d LINODEID=$linodeid\&LABEL=$NODE_NAME

# Get linode Public IP
$LINODEAPI -c linode.ip.list -d LinodeID=$linodeid | grep IPADDRESS | grep -v IPADDRESSID | sed 's/^.*:"//' | sed 's/"//' > $workdir/publicip.txt
publicip=`cat $workdir/publicip.txt`

#Get Linode Gateway
$LINODEAPI -c linode.ip.list -d LinodeID=$linodeid | grep IPADDRESS | grep -v IPADDRESSID | sed 's|^.*:"||' | sed 's/"//' | sed 's/\./ /g' | awk -v OFS=. '{print $1, $2, $3}' > $workdir/gateway.txt
gateway=`cat $workdir/gateway.txt`

# Add Private network interface
$LINODEAPI -c linode.ip.addprivate -d LINODEID=$linodeid | grep IPADDRESS | grep -v IPADDRESSID | sed 's/^.*:"//' | sed 's/"//' > $workdir/privateip.txt
privateip=`cat $workdir/privateip.txt`

# Get linode disk space
diskspace=`$LINODEAPI -c linode.list -d LinodeID=$linodeid | grep TOTALHD | sed 's/^.*://'`
bootspace=2048
swapspace=2048
coreosspace=$(($diskspace - $bootspace - $swapspace))
if [ "$DATA_SIZE" != "no-data" ]; then
  coreosspace=$(($diskspace - $bootspace - $swapspace - $DATA_SIZE))
fi

# Create BootOS (Debian)
$LINODEAPI -c linode.disk.createfromdistribution -d LinodeID=$linodeid\&DistributionID=130\&Label=BootHD\&Size=$bootspace\&rootPass=$PASSWD

# Create CoreOS Partition
$LINODEAPI -c linode.disk.create -d LinodeID=$linodeid\&Label=CoreOS\&Type=raw\&Size=$coreosspace

# Create Swap Partition
$LINODEAPI -c linode.disk.create -d LinodeID=$linodeid\&Label=SWAP\&Type=swap\&Size=$swapspace

# Create Data Partition if provided space size by user
if [ "$DATA_SIZE" != "no-data" ]; then
  $LINODEAPI -c linode.disk.create -d LinodeID=$linodeid\&Label=Data\&Type=raw\&Size=$DATA_SIZE
    # Get All Disks ID's
  diskids=`$LINODEAPI -c linode.disk.list -d LINODEID=$linodeid | grep DISKID | sed 's/^.*://' | xargs -n 4 echo | sed 's/ /,/g'`
else
    # Get All Disks ID's
  diskids=`$LINODEAPI -c linode.disk.list -d LINODEID=$linodeid | grep DISKID | sed 's/^.*://' | xargs -n 3 echo | sed 's/ /,/g'`
fi

# Create Install Profile for Installation of CoreOS
$LINODEAPI -c linode.config.create -d LINODEID=$linodeid\&Label=Install\&KERNELID=138\&DiskList=$diskids\&RootDeviceNum=1 | grep ConfigID | sed 's/^.*://' > $workdir/install-config-id.txt
instcfg=`cat $workdir/install-config-id.txt`

# Create CoreOS Profile for booting operational version.
$LINODEAPI -c linode.config.create -d LINODEID=$linodeid\&Label=CoreOS\&KERNELID=95\&DiskList=$diskids\&RootDeviceNum=1 | grep ConfigID | sed 's/^.*://' > $workdir/coreos-config-id.txt
coreoscfg=`cat $workdir/coreos-config-id.txt`

## Boot Installation
$LINODEAPI -c linode.boot -d LINODEID=$linodeid\&ConfigID=$instcfg
#Waiting for system to boot
bootstatus=""
while [[ $bootstatus != "ok" ]]; do
  set +e
  log "Waiting for system to boot..."
  sleep 5
  bootstatus=`sshpass -p $PASSWD ssh -o ConnectionAttempts=100 -o ConnectTimeout=5 -o StrictHostKeyChecking=no -l root $publicip echo ok 2>&1`
done
set -e # TODO: wrap it in function and set/unset it there
log "Systm booted. Jumping to next stage"

# Send cloud-config file to server
echo "$CLOUD_CONFIG_CONTENT" | sshpass -p $PASSWD ssh -o StrictHostKeyChecking=no -l root $publicip "cat > /root/cloud-config.yaml; log 'Provided cloud config:' && echo; cat /root/cloud-config.yaml; echo"

# Send CoreOS installation program
sshpass -p $PASSWD ssh -o StrictHostKeyChecking=no -l root $publicip "curl -s https://raw.githubusercontent.com/million12/linodeapi/master/prepare_coreos_boot.sh -o /root/prepare_coreos_boot.sh"
sshpass -p $PASSWD ssh -o StrictHostKeyChecking=no -l root $publicip "chmod +x /root/prepare_coreos_boot.sh"

# Run CoreOS Installation and configuration
sshpass -p $PASSWD ssh -o StrictHostKeyChecking=no -l root $publicip "/root/prepare_coreos_boot.sh $publicip $privateip $gateway $TOKEN"
# Shutdown Boot Install
$LINODEAPI -c linode.shutdown -d LinodeID=$linodeid
# Boot into CoreOS
$LINODEAPI -c linode.boot -d LINODEID=$linodeid\&ConfigID=$coreoscfg

#
# Print summary info
#
log
log "Node ${bold}${white}$NODE_NAME${reset} created and you can now log in."
log "Public IP: ${bold}${white}$publicip${reset}."
log "Log in using, for example:" "ssh core@$publicip" # Node: don't use here $USER as it's not available inside Docker!
log
